openapi: 3.0.3
info:
  title: Normal Map & 3D Model Processing API
  version: 1.0.0
  description: API for uploading normal maps, generating 3D models, and serving files for web use
servers:
  - url: https://api.example.com/v1
    description: Production server

paths:
  /api/upload-normal:
    post:
      summary: Upload a normal map image
      description: |
        Uploads a single normal map image file. The server will:
        1. Validate that the file is an image (JPEG, PNG, GIF, WebP, BMP, TIFF)
        2. Validate that the image content is a proper normal map
        3. Save the file to storage
        4. Generate 3D model files (.obj, .mtl) from the normal map
        5. Return the SHA-256 hash of the normal map image

        Note: Normal maps must follow standard conventions where:
        - Red channel (X) represents horizontal direction
        - Green channel (Y) represents vertical direction
        - Blue channel (Z) represents depth
        - Values should be centered around 128 (neutral gray)
      operationId: uploadNormalMap
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              properties:
                file:
                  type: string
                  format: binary
                  description: The normal map image file to upload
              required:
                - file
      responses:
        "200":
          description: Normal map processed successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  hash:
                    type: string
                    example: "e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855"
                    description: SHA-256 hash of the normal map image
                required:
                  - hash
        "400":
          description: Bad request - missing file or invalid file format
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: "File must be an image (JPEG, PNG, GIF, WebP, BMP, or TIFF)"
                required:
                  - error
        "413":
          description: File too large
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: "File size exceeds maximum allowed limit (10MB)"
                required:
                  - error
        "415":
          description: Unsupported media type
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: "Unsupported file type. Please upload an image file."
                required:
                  - error
        "422":
          description: Invalid normal map content
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: "Uploaded image is not a valid normal map. RGB channels must contain normal vector data centered around neutral gray (128,128,128)."
                  details:
                    type: array
                    items:
                      type: string
                    example:
                      - "Blue channel values outside expected range (64-192)"
                      - "Missing neutral gray baseline in red/green channels"
                required:
                  - error
        "500":
          description: Internal server error
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: "Internal server error occurred during 3D model generation"
                required:
                  - error

  /api/upload-list/{hash}:
    get:
      summary: List all generated files in directory
      description: |
        Returns a list of all files generated from a normal map upload, including:
        - Original normal map image
        - Generated height map image
        - 3D model files (.obj, .mtl)

        Each entry includes metadata about how to use the file in web contexts.
      parameters:
        - name: hash
          in: path
          required: true
          schema:
            type: string
            minLength: 64
            maxLength: 64
          description: SHA-256 hash identifying the directory
      responses:
        "200":
          description: Successful operation
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  properties:
                    filename:
                      type: string
                      example: "model.obj"
                    size:
                      type: integer
                      example: 24680
                    last_modified:
                      type: string
                      format: date-time
                      example: "2023-07-20T14:23:00Z"
                    type:
                      type: string
                      enum: [image, model, metadata]
                      example: "model"
                      description: |
                        File type classification:
                        - image: Can be embedded in <img> tags
                        - model: 3D model file for WebGL/three.js
                        - metadata: Supporting files
                    url:
                      type: string
                      format: uri
                      example: "https://api.example.com/upload/e3b0c44.../model.obj"
                      description: Direct URL for accessing the file

                  required:
                    - filename
                    - size
                    - type
                    - url
        "404":
          description: Directory not found
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: "Directory with hash 9f86d08... not found"
                required:
                  - error
        "500":
          description: Internal server error
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: "Failed to retrieve directory contents"
                required:
                  - error

  /uploads/{hash}/{filename}:
    get:
      summary: Serve file for web usage
      description: |
        Retrieves files with appropriate handling based on file type:

        For IMAGE files (PNG, JPEG, etc.):
        - Returns with correct image/* Content-Type
        - Sets cache headers for browser optimization
        - Safe for direct <img> tag embedding

        For 3D MODEL files (.obj, .mtl):
        - Returns with application/octet-stream Content-Type
        - Suitable for downloading or loading via three.js
        - Not intended for direct <img> embedding

        Example HTML usage:
        <!-- For images -->
        <img src="https://api.example.com/upload/e3b0c44.../height_map.png">

        <!-- For 3D models in JavaScript -->
        fetch('https://api.example.com/upload/e3b0c44.../model.obj')
          .then(response => response.text())
          .then(objData => { /* load into three.js */ });
      parameters:
        - name: hash
          in: path
          required: true
          schema:
            type: string
            minLength: 64
            maxLength: 64
          description: SHA-256 hash identifying the directory
        - name: filename
          in: path
          required: true
          schema:
            type: string
          description: Name of the file to retrieve
      responses:
        "200":
          description: File retrieved successfully
          content:
            image/png:
              schema:
                type: string
                format: binary
            image/jpeg:
              schema:
                type: string
                format: binary
            application/octet-stream:
              schema:
                type: string
                format: binary
          headers:
            Content-Type:
              description: MIME type based on file content
              schema:
                type: string
            Cache-Control:
              description: Caching directives optimized per file type
              schema:
                type: string
                example: "public, max-age=31536000, immutable"
        "404":
          description: File not found
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: "File 'model.obj' not found in directory e3b0c44..."
                required:
                  - error
        "400":
          description: Invalid filename format
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: "Filename contains invalid characters or path traversal attempt"
                required:
                  - error
        "415":
          description: Unsupported file format for requested operation
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: "File 'data.txt' is not a supported format for web delivery"
                required:
                  - error
        "500":
          description: Internal server error
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: "Failed to process file for web delivery"
                required:
                  - error
